moment.locale(navigator.language||navigator.userLanguage);var reader,count=0,today=moment().startOf("day"),day=moment(today).startOf("day"),endDay=moment(day).endOf("day"),xml=null;function updateDate(){var e='<span id="previousDate" class="date-nav'+(day.isSame(today)||null==xml?" disabled":"")+'">&laquo;</span>';e+="<span> "+day.format("L")+" </span>",e+='<span id="nextDate" class="date-nav'+(null==xml?" disabled":"")+'">&raquo;</span>',$(".guide-date").empty(),$(".guide-date").append(e),null!=xml&&(day.isSame(today)||$(".guide-date").find("#previousDate").click(function(){day.add(-1,"days"),eraseListings(),endDay=moment(day).endOf("day"),updateDate()}),$(".guide-date").find("#nextDate").click(function(){day.add(1,"days"),eraseListings(),endDay=moment(day).endOf("day"),updateDate()}))}function eraseListings(){$(document).find('td[colspan="48"]').each(function(){$(this).empty()}),installChannelObserver()}function abortRead(){reader.abort()}function errorHandler(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case e.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case e.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}}function updateProgress(e){if(e.lengthComputable)Math.round(e.loaded/e.total*100)}function handleFileSelect(e){eraseAll(),(reader=new FileReader).onerror=errorHandler,reader.onprogress=updateProgress,reader.onabort=function(e){alert("File read cancelled")},reader.onloadstart=function(e){},reader.onload=function(e){var t=e.target.result;xmlDoc=$.parseXML(t),$xml=$(xmlDoc),xml=$xml,processXML()},reader.readAsText(e.target.files[0])}function programme(e,t,a){var i="";return xml.find("programme[channel='"+e+"']").each(function(){var e=moment($(this).attr("start"),"YYYYMMDDHHmmss Z"),d=moment($(this).attr("stop"),"YYYYMMDDHHmmss Z"),n=moment(d);if(d.isAfter(endDay)&&(n=endDay),moment(e).isBetween(day,endDay,null,"[]")){var s=moment.duration(e.diff(day)).valueOf()/6e4;duration=moment.duration(d.diff(e)).valueOf()/6e4;var r=moment.duration(n.diff(e)).valueOf()/6e4,o=$(this).find("title").text(),l="",c="",g="",m="",v="",u="",h="",f="",p="";$(this).find("sub-title").length&&(l=$(this).find("sub-title").text()),$(this).find("desc").length&&(c=$(this).find("desc").text()),$(this).find("icon").length&&$(this).find("icon").attr("src")&&(g=$(this).find("icon").attr("src")),$(this).find("episode-num").length&&$(this).find("episode-num").attr("system")&&"onscreen"==$(this).find("episode-num").attr("system")&&(m=$(this).find("episode-num").text()),$(this).find("rating").length&&$(this).find("rating").find("value").length&&(v=$(this).find("rating").find("value").text()),$(this).find("star-rating").length&&$(this).find("star-rating").find("value").length&&(u=$(this).find("star-rating").find("value").text()),$(this).find("credits").length&&($(this).find("credits").find("director").each(function(){h+=$(this).text()+", "}),h.length>=2&&(h=h.substring(0,h.length-2)),$(this).find("credits").find("actor").each(function(){f+=$(this).text()+", "}),f.length>=2&&(f=f.substring(0,f.length-2))),$(this).find("category").each(function(){p+=$(this).text()+" / "}),p.length>=3&&(p=p.substring(0,p.length-3)),i+='<div class="guide-programme" style="left: '+5*s+"px; width: "+5*r+'px;">',i+='<div class="guide-programme-container">',i+='<div><button type="button" class="btn btn-link guide-programme-title" data-toggle="modal" data-target="#programme-'+count+'">'+o+"</button></div>",i+='<div class="guide-programme-hour">'+e.format("HH:mm")+"-"+d.format("HH:mm")+"</div>",i+='<div class="guide-programme-episode">'+m+"</div>",i+='<div class="guide-programme-container2">',i+='<div class="guide-programme-imageholder">'+(""!=g?'<img src="'+g+'" class="img-fluid guide-programme-image" loading="lazy">':"")+"</div>",i+='<div class="guide-programme-rating"><span class="badge badge-primary">'+v+"</span></div>",i+="</div>",i+="</div>",i+="</div>",i+='<div class="modal fade" id="programme-'+count+'" tabindex="-1" role="dialog" aria-labelledby="programmeLabel-1" aria-hidden="true">',i+='<div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg" role="document">',i+='<div class="modal-content">',i+='<div class="modal-header">',i+='<h5 class="modal-title" id="programmeLabel-1">'+o+"</h5>",i+='<button type="button" class="close" data-dismiss="modal" aria-label="Close">',i+='<span aria-hidden="true">&times;</span>',i+="</button>",i+="</div>",i+='<div class="modal-body">',i+='<div class="row">',i+='<div class="col">',i+='<div class="row row-cols-2 row-cols-md-4">',i+='<div class="col"><strong>Channel:</strong></div>',i+='<div class="col text-right" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">'+a+"</div>",i+='<div class="col">'+(""!=m?"<strong>Episode:</strong>":"")+"</div>",i+='<div class="col text-right" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">'+m+"</div>",i+='<div class="col"><strong>Start time:</strong></div>',i+='<div class="col text-right">'+e.format("HH:mm")+"</div>",i+='<div class="col"><strong>End time:</strong></div>',i+='<div class="col text-right">'+d.format("HH:mm")+"</div>",i+='<div class="col"><strong>Duration:</strong></div>',i+='<div class="col text-right">'+duration+" minutes</div>",i+='<div class="col">'+(""!=v?"<strong>Rating:</strong>":"")+"</div>",i+='<div class="col text-right" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;"><span class="badge badge-primary">'+v+"</span></div>",i+='<div class="col">'+(""!=l?"<strong>Subtitle:</strong>":"")+"</div>",i+='<div class="col text-right" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">'+l+"</div>",i+='<div class="col">'+(""!=u?"<strong>Star rating:</strong>":"")+"</div>",i+='<div class="col text-right" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">'+u+"</div>",i+="</div>   ",i+="</div>",i+='<div class="col-auto">',i+='<div class="guide-channel text-center" style="width: 80px;">'+(""!=t?'<img src="'+t+'" class="img-fluid guide-channel-image">':"")+"</div>",i+="</div>",i+="</div>",i+='<div class="row border-top">',i+='<div class="col">',i+=c,i+="</div>",i+='<div class="col-auto">',i+='<div class="guide-channel text-center" style="width: 150px;">'+(""!=g?'<img src="'+g+'" class="img-fluid ">':"")+"</div>",i+="</div>",i+="</div>",""==h&&""==f&&""==p||(i+='<div class="row border-top">',i+='<div class="col">',i+='<div class="row row-cols-2">',i+='<div class="col">'+(""!=p?"<strong>Category:</strong>":"")+"</div>",i+='<div class="col">'+p+"</div>",i+='<div class="col">'+(""!=h?"<strong>Director:</strong>":"")+"</div>",i+='<div class="col">'+h+"</div>",i+='<div class="col">'+(""!=f?"<strong>Actors:</strong>":"")+"</div>",i+='<div class="col">'+f+"</div>",i+="</div>   ",i+="</div>",i+="</div>"),i+="</div>",i+='<div class="modal-footer">',i+='<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>',i+="</div>",i+="</div>",i+="</div>",i+="</div>"}count++}),i}function processXML(){var e="";$channel=xml.find("channel").each(function(){var t=$(this).attr("id"),a=$(this).find("display-name").text(),i="";$(this).find("icon").length&&$(this).find("icon").attr("src")&&(i=$(this).find("icon").attr("src")),e+="<tr>",e+='<td><div class="guide-channel text-center" channelid="'+t+'">'+(""!=i?'<img src="'+i+'" class="img-fluid guide-channel-image" loading="lazy">':"")+'<div class="guide-channel-name">'+a+"</div></div></td>",e+='<td colspan="48">',e+="</td>",e+="</tr>"}),$("#guide-body").append(e),updateDate(),installChannelObserver()}function installChannelObserver(){let e=new IntersectionObserver(function(e,t){e.forEach(e=>{if(e.isIntersecting){var a=$(e.target).attr("channelid"),i="",d=$(e.target).find(".guide-channel-name").text();$(e.target).find("img").length&&$(e.target).find("img").attr("src")&&(i=$(e.target).find("img").attr("src")),$(e.target).parent().next().append(programme(a,i,d)),t.unobserve(e.target)}})},{rootMargin:"0px 0px 0px 0px",threshold:0});document.querySelectorAll("[channelid]").forEach(t=>{e.observe(t)})}function eraseAll(){$("#guide-body").empty();moment(day).endOf("day");updateDate()}document.getElementById("file").addEventListener("change",handleFileSelect,!1),$(".load-example").click(function(){eraseAll(),$.ajax({type:"GET",dataType:"binary",url:"guide.xml.gz",cache:!0,error:function(e,t,a){console.log(a),$("#loading").on("shown.bs.modal",function(e){$("#loading").modal("hide")}),$("#loading").hide("hide"),$("#errorLoading").modal("show")},xhr:function(){var e=new window.XMLHttpRequest;return e.responseType="arraybuffer",e.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;$("#progress-bar").css("width",Math.round(100*t)+"%")}},!1),e.addEventListener("load",function(){if(200===e.status){var t=new Uint8Array(e.response),a=pako.inflate(t,{to:"string"});t=null,a='<?xml version="1.0" encoding="UTF-8"?>'+a.replace(/[\w\W]+?\n+?/,""),xmlDoc=$.parseXML(a),$xml=$(xmlDoc),xml=$xml,processXML(),$("#loading").on("shown.bs.modal",function(e){$("#loading").modal("hide")}),$("#loading").modal("hide")}}),e},beforeSend:function(){$("#loading").off("shown.bs.modal"),$("#loading").modal("show")},success:function(e){$("#progress-bar").css("width","100%")}})}),updateDate();